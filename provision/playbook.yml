- name: Deploy Redmine
  hosts: all
  vars:
    without_php: true
  roles:
    - role: common
    - role: mariadb
    - role: nodejs
    - role: tools
    - role: rdebug_ide
    - role: nginx
      when: not without_php | default(false)
    - role: php
      when: not without_php | default(false)
    - role: redis
      when: not without_php | default(false)
  tasks:
    - name: set user config
      block:
        - name: set user git config
          git_config:
            name: "{{ item.name }}"
            scope: global
            value: "{{ item.value }}"
          loop: "{{ user_git_config | default([])  }}"
        - name: set variables
          ansible.builtin.set_fact:
            redmine_db_host: "{{ redmine_db_cfg.development.host }}"
            redmine_db_name: "{{ redmine_db_cfg.development.database }}"
            redmine_db_user: "{{ redmine_db_cfg.development.username }}"
            redmine_db_password: "{{ redmine_db_cfg.development.password }}"
            db_character_set: "{{ mariadb_databases[0].encoding | default(mariadb_default_charset | default('utf8mb4')) }}"
        - name: set enviromnet variables(TBLS_DSN)
          ansible.builtin.lineinfile:
            path: ~/.bashrc
            regexp: '^export TBLS_DSN='
            line: export TBLS_DSN=my://{{ redmine_db_user }}:{{ redmine_db_password }}@{{ redmine_db_host }}:3306/{{ redmine_db_name }}
        - name: set enviromnet variables(TBLS_DOC_PATH)
          ansible.builtin.lineinfile:
            path: ~/.bashrc
            regexp: '^export TBLS_DOC_PATH='
            line: export TBLS_DOC_PATH=/vagrant/dbdoc
        - name: copy tbls setting
          ansible.builtin.copy:
            src: tbls.yml
            dest: ~/tbls.yml
            mode: "0644"
        - name: create mysql connection file
          ini_file:
            path: ~/.my.cnf
            create: true
            section: client
            option: "{{ item.key | replace('_', '-') }}"
            value: "{{ item.value | string }}"
            mode: "0640"
          with_dict:
            host: "{{ redmine_db_host }}"
            database: "{{ redmine_db_name }}"
            user: "{{ redmine_db_user }}"
            password: "{{ redmine_db_password }}"
            default_character_set: "{{ db_character_set }}"
        - name: create user script directory
          ansible.builtin.file:
            path: ~/bin
            state: directory
            mode: "0755"
        - name: copy user scripts
          ansible.builtin.copy:
            src: "{{ item }}"
            dest: ~/bin/{{ item | basename }}
            mode: "0755"
          loop: "{{ lookup('fileglob', 'files/scripts/*', wantlist=True) }}"
      become: false
    - name: create MariaDB users
      mysql_user:
        name: "{{ redmine_db_user }}"
        password: "{{ redmine_db_password }}"
        host: "%"
        priv: "{{ redmine_db_name }}.*:ALL"
        login_unix_socket: "{{ mariadb_unix_socket_path }}"
      no_log: true
    - name: allow firewall port
      ufw:
        rule: allow
        port: "{{ item | string }}"
      loop:
        # MariaDB Server
        - 3306
        # Mailhog
        - 8025
  post_tasks:
    - name: set other post task files
      ansible.builtin.set_fact:
        post_task_file: "{{ lookup('first_found', post_task_files, errors='ignore') }}"
      vars:
        post_task_files:
          files:
            - post_task.yml
          paths:
            - ..
            - .
    - name: execute post task
      block:
        - name: set variable for post task file base directory
          ansible.builtin.set_fact:
            post_task_base_dir: "{{ post_task_file | dirname }}"
        - name: execute post task
          ansible.builtin.include_tasks: "{{ post_task_file }}"
      when: post_task_file | length > 0
